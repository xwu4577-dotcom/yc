<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五层全动态交互八字排盘 (时间追踪修复版)</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>
    <style>
        :root {
            --bg-gray: #f5f5f5;
            --border-color: #eaeaea;
            --active-bg: #fff3e0; 
            --active-border: #f57c00;
        }

        body { font-family: -apple-system, sans-serif; margin: 0; background-color: #ececec; color: #333; }
        .app-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding-bottom: 20px;}
        
        .input-section { padding: 15px; background: #fff; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px;}
        .input-section input, .input-section select { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        .input-section button { width: 100%; padding: 12px; background-color: #d4af37; color: #fff; font-size: 16px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }

        .header-section { background: #222; color: #fff; padding: 15px; }
        .user-info p { margin: 5px 0; font-size: 13px; color: #ccc; }

        .bazi-grid { display: grid; grid-template-columns: 1fr repeat(4, 1fr); text-align: center; border-bottom: 8px solid var(--bg-gray); }
        .grid-cell { padding: 8px 2px; border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); font-size: 13px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .col-header { background-color: var(--bg-gray); color: #888; font-size: 12px; }
        .row-label { background-color: #fff; color: #888; text-align: left; padding-left: 8px; align-items: flex-start;}
        
        .ganzhi-text { font-size: 18px; font-weight: bold; margin: 2px 0; }
        .ss-text { font-size: 11px; color: #888; margin-right: 3px; }
        .gz-row { display: flex; align-items: center; justify-content: center; width: 100%;}
        
        .timeline-container { font-size: 13px; }
        .qiyun-bar { 
            padding: 10px 15px; background: #fff; border-bottom: 1px solid var(--border-color); 
            color: #555; font-size: 12px; display: flex; justify-content: space-between; align-items: center;
        }
        .now-btn {
            background-color: #f57c00; color: #fff; border: none; border-radius: 4px; 
            padding: 4px 14px; font-size: 12px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background 0.2s;
        }
        .now-btn:active { background-color: #e65100; transform: scale(0.95); }
        
        .scroll-wrapper { display: flex; background: #fff; border-bottom: 1px solid var(--border-color); }
        .row-title { width: 40px; text-align: center; color: #888; font-size: 12px; border-right: 1px solid #eee; padding-top: 15px; background: #fafafa; flex-shrink: 0;}
        
        .scroll-row { 
            display: flex; overflow-x: auto; flex: 1; cursor: grab; user-select: none; 
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .scroll-row::-webkit-scrollbar { display: none; }
        .scroll-row.active-drag { cursor: grabbing; }

        .item-box { min-width: 55px; padding: 10px 2px; text-align: center; border-right: 1px solid var(--border-color); flex-shrink: 0; transition: background 0.2s;}
        .item-box:hover { background: #f9f9f9; }
        .item-box.active { background-color: var(--active-bg); border-bottom: 2px solid var(--active-border); }
        
        .top-text { font-size: 11px; color: #888; margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="input-section">
        <select id="gender" style="flex: 0.3;"><option value="1">乾造</option><option value="0">坤造</option></select>
        <input type="datetime-local" id="birthTime" value="1995-02-06T02:00" style="flex: 0.7;">
        <button onclick="initPan()">排盘并推演运势</button>
    </div>

    <div class="header-section">
        <h3 style="margin: 0 0 5px 0;">命盘信息</h3>
        <p id="uiSolar">阳历：-</p>
        <p id="uiLunar">阴历：-</p>
    </div>

    <div class="bazi-grid" id="mainGrid"></div>

    <div class="timeline-container">
        <div class="qiyun-bar">
            <span id="qiyunText">起运时间：-</span>
            <button class="now-btn" onclick="snapToNow()">今</button>
        </div>
        
        <div class="scroll-wrapper">
            <div class="row-title">大运</div>
            <div class="scroll-row" id="dayunRow"></div>
        </div>
        <div class="scroll-wrapper">
            <div class="row-title">流年</div>
            <div class="scroll-row" id="liunianRow"></div>
        </div>
        <div class="scroll-wrapper">
            <div class="row-title">流月</div>
            <div class="scroll-row" id="liuyueRow"></div>
        </div>
        <div class="scroll-wrapper">
            <div class="row-title" style="color:#d4af37;">流日</div>
            <div class="scroll-row" id="liuriRow"></div>
        </div>
        <div class="scroll-wrapper">
            <div class="row-title" style="color:#e69138;">流时</div>
            <div class="scroll-row" id="liushiRow"></div>
        </div>
    </div>
</div>

<script>
    let globalDaYuns = []; 
    let globalDayGan = ''; 
    let isDragging = false; 

    const SHI_SHEN_MAP = {
        '甲': {'甲':'比肩','乙':'劫财','丙':'食神','丁':'伤官','戊':'偏财','己':'正财','庚':'七杀','辛':'正官','壬':'偏印','癸':'正印'},
        '乙': {'甲':'劫财','乙':'比肩','丙':'伤官','丁':'食神','戊':'正财','己':'偏财','庚':'正官','辛':'七杀','壬':'正印','癸':'偏印'},
        '丙': {'甲':'偏印','乙':'正印','丙':'比肩','丁':'劫财','戊':'食神','己':'伤官','庚':'偏财','辛':'正财','壬':'七杀','癸':'正官'},
        '丁': {'甲':'正印','乙':'偏印','丙':'劫财','丁':'比肩','戊':'伤官','己':'食神','庚':'正财','辛':'偏财','壬':'正官','癸':'七杀'},
        '戊': {'甲':'七杀','乙':'正官','丙':'偏印','丁':'正印','戊':'比肩','己':'劫财','庚':'食神','辛':'伤官','壬':'偏财','癸':'正财'},
        '己': {'甲':'正官','乙':'七杀','丙':'正印','丁':'偏印','戊':'劫财','己':'比肩','庚':'伤官','辛':'食神','壬':'正财','癸':'偏财'},
        '庚': {'甲':'偏财','乙':'正财','丙':'七杀','丁':'正官','戊':'偏印','己':'正印','庚':'比肩','辛':'劫财','壬':'食神','癸':'伤官'},
        '辛': {'甲':'正财','乙':'偏财','丙':'正官','丁':'七杀','戊':'正印','己':'偏印','庚':'劫财','辛':'比肩','壬':'伤官','癸':'食神'},
        '壬': {'甲':'食神','乙':'伤官','丙':'偏财','丁':'正财','戊':'七杀','己':'正官','庚':'偏印','辛':'正印','壬':'比肩','癸':'劫财'},
        '癸': {'甲':'伤官','乙':'食神','丙':'正财','丁':'偏财','戊':'正官','己':'七杀','庚':'正印','辛':'偏印','壬':'劫财','癸':'比肩'}
    };
    const ZHI_MAIN_QI = { '子':'癸', '丑':'己', '寅':'甲', '卯':'乙', '辰':'戊', '巳':'丙', '午':'丁', '未':'己', '申':'庚', '酉':'辛', '戌':'戊', '亥':'壬' };
    const SHORT_SHI_SHEN = { '比肩':'比', '劫财':'劫', '食神':'食', '伤官':'伤', '偏财':'才', '正财':'财', '七杀':'杀', '正官':'官', '偏印':'枭', '正印':'印' };

    function getColor(char) {
        if ('庚辛申酉'.includes(char)) return '#e69138';
        if ('甲乙寅卯'.includes(char)) return '#38761d';
        if ('壬癸子亥'.includes(char)) return '#1155cc';
        if ('丙丁巳午'.includes(char)) return '#cc0000';
        if ('戊己辰戌丑未'.includes(char)) return '#b45f06';
        return '#333';
    }

    function getSS(dayGan, char, isZhi = false) {
        if(!dayGan || !char) return '';
        let target = isZhi ? ZHI_MAIN_QI[char] : char;
        let full = SHI_SHEN_MAP[dayGan][target];
        return SHORT_SHI_SHEN[full] || full;
    }

    function initPan() {
        const dateStr = document.getElementById('birthTime').value;
        const gender = parseInt(document.getElementById('gender').value);
        if(!dateStr) return;
        
        const date = new Date(dateStr);
        const lunar = Lunar.fromDate(date);
        const bazi = lunar.getEightChar();
        const yun = bazi.getYun(gender);
        
        globalDayGan = bazi.getDayGan();
        globalDaYuns = yun.getDaYun();

        document.getElementById('uiSolar').innerText = `阳历：${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 ${date.getHours()}时`;
        document.getElementById('uiLunar').innerText = `阴历：${lunar.getYearInGanZhi()}年 ${lunar.getMonthInChinese()}月 ${lunar.getDayInChinese()} ${bazi.getTimeZhi()}时`;
        document.getElementById('qiyunText').innerText = `起运时间：出生后 ${yun.getStartYear()}年 ${yun.getStartMonth()}个月 ${yun.getStartDay()}天起运`;

        renderBaseGrid(bazi);
        renderDaYunList(); 
    }

    function renderBaseGrid(bazi) {
        const pillars = [
            { t: '年柱', g: bazi.getYearGan(), z: bazi.getYearZhi() },
            { t: '月柱', g: bazi.getMonthGan(), z: bazi.getMonthZhi() },
            { t: '日柱', g: bazi.getDayGan(), z: bazi.getDayZhi() },
            { t: '时柱', g: bazi.getTimeGan(), z: bazi.getTimeZhi() }
        ];
        let html = `<div class="grid-cell col-header row-label">四柱</div>`;
        pillars.forEach(p => html += `<div class="grid-cell col-header">${p.t}</div>`);
        
        html += `<div class="grid-cell row-label">天干</div>`;
        pillars.forEach(p => html += `<div class="grid-cell"><span class="ganzhi-text" style="color:${getColor(p.g)}">${p.g}</span></div>`);
        
        html += `<div class="grid-cell row-label">地支</div>`;
        pillars.forEach(p => html += `<div class="grid-cell"><span class="ganzhi-text" style="color:${getColor(p.z)}">${p.z}</span></div>`);
        
        document.getElementById('mainGrid').innerHTML = html;
    }

    function renderDaYunList() {
        let html = '';
        for (let i = 0; i < 8; i++) {
            if(!globalDaYuns[i]) continue;
            const dy = globalDaYuns[i];
            const gz = dy.getGanZhi();
            const gan = gz.charAt(0);
            const zhi = gz.charAt(1);
            
            html += `
                <div class="item-box" id="dy-box-${i}" onclick="selectDaYun(${i})">
                    <div class="top-text">${dy.getStartYear()}年</div>
                    <div class="top-text">${dy.getStartAge()}岁</div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, gan)}</span><span class="ganzhi-text" style="color:${getColor(gan)}">${gan}</span></div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, zhi, true)}</span><span class="ganzhi-text" style="color:${getColor(zhi)}">${zhi}</span></div>
                </div>`;
        }
        document.getElementById('dayunRow').innerHTML = html;
        selectDaYun(0); 
    }

    function selectDaYun(dyIndex) {
        if (isDragging) return; 
        document.querySelectorAll('#dayunRow .item-box').forEach(el => el.classList.remove('active'));
        const box = document.getElementById(`dy-box-${dyIndex}`);
        if(box) box.classList.add('active');

        const liuNians = globalDaYuns[dyIndex].getLiuNian(); 
        let html = '';
        liuNians.forEach((ln, lnIndex) => {
            const gz = ln.getGanZhi();
            const gan = gz.charAt(0);
            const zhi = gz.charAt(1);
            
            html += `
                <div class="item-box" id="ln-box-${lnIndex}" onclick="selectLiuNian(${dyIndex}, ${lnIndex})">
                    <div class="top-text">${ln.getYear()}</div>
                    <div class="top-text">${ln.getAge()}岁</div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, gan)}</span><span class="ganzhi-text" style="color:${getColor(gan)}">${gan}</span></div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, zhi, true)}</span><span class="ganzhi-text" style="color:${getColor(zhi)}">${zhi}</span></div>
                </div>`;
        });
        document.getElementById('liunianRow').innerHTML = html;
        selectLiuNian(dyIndex, 0); 
    }

    function selectLiuNian(dyIndex, lnIndex) {
        if (isDragging) return;
        document.querySelectorAll('#liunianRow .item-box').forEach(el => el.classList.remove('active'));
        const box = document.getElementById(`ln-box-${lnIndex}`);
        if(box) box.classList.add('active');

        const liuYues = globalDaYuns[dyIndex].getLiuNian()[lnIndex].getLiuYue(); 
        let html = '';
        liuYues.forEach((ly, lyIndex) => {
            const gz = ly.getGanZhi();
            const gan = gz.charAt(0);
            const zhi = gz.charAt(1);
            
            html += `
                <div class="item-box" id="ly-box-${lyIndex}" onclick="selectLiuYue(${dyIndex}, ${lnIndex}, ${lyIndex})">
                    <div class="top-text">${ly.getMonthInChinese()}月</div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, gan)}</span><span class="ganzhi-text" style="color:${getColor(gan)}">${gan}</span></div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, zhi, true)}</span><span class="ganzhi-text" style="color:${getColor(zhi)}">${zhi}</span></div>
                </div>`;
        });
        document.getElementById('liuyueRow').innerHTML = html;
        selectLiuYue(dyIndex, lnIndex, 0); 
    }

    function selectLiuYue(dyIndex, lnIndex, lyIndex) {
        if (isDragging) return;
        document.querySelectorAll('#liuyueRow .item-box').forEach(el => el.classList.remove('active'));
        const box = document.getElementById(`ly-box-${lyIndex}`);
        if(box) box.classList.add('active');

        const ln = globalDaYuns[dyIndex].getLiuNian()[lnIndex];
        const ly = ln.getLiuYue()[lyIndex];

        let monthIdx = typeof ly.getIndex === 'function' ? ly.getIndex() : lyIndex;
        let jsYear = ln.getYear();
        let jsMonth = monthIdx + 1; 
        
        if (jsMonth > 11) { jsMonth -= 12; jsYear++; }

        // 修复：生成 35 天，从当月公历 1号起算，确切囊括整个节气月的所有公历日期
        let jsDate = new Date(jsYear, jsMonth, 1);
        let html = '';
        let firstDayGan = ''; 
        
        for (let i = 0; i < 35; i++) {
            let curLunar = Lunar.fromDate(jsDate);
            let bazi = curLunar.getEightChar();
            let gan = bazi.getDayGan();
            let zhi = bazi.getDayZhi();
            
            if(i === 0) firstDayGan = gan; 
            let displayDate = `${jsDate.getMonth() + 1}/${jsDate.getDate()}`;
            
            html += `
                <div class="item-box" id="lr-box-${i}" onclick="selectLiuRi('${gan}', ${i})">
                    <div class="top-text">${displayDate}</div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, gan)}</span><span class="ganzhi-text" style="color:${getColor(gan)}">${gan}</span></div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, zhi, true)}</span><span class="ganzhi-text" style="color:${getColor(zhi)}">${zhi}</span></div>
                </div>`;
            jsDate.setDate(jsDate.getDate() + 1); 
        }
        document.getElementById('liuriRow').innerHTML = html;
        selectLiuRi(firstDayGan, 0); 
    }

    function selectLiuRi(dayGan, lrIndex) {
        if (isDragging) return;
        document.querySelectorAll('#liuriRow .item-box').forEach(el => el.classList.remove('active'));
        const box = document.getElementById(`lr-box-${lrIndex}`);
        if(box) box.classList.add('active');

        const shichenZhi = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
        const hourGanMap = { '甲':'甲', '己':'甲', '乙':'丙', '庚':'丙', '丙':'戊', '辛':'戊', '丁':'庚', '壬':'庚', '戊':'壬', '癸':'壬' };
        
        const startGan = hourGanMap[dayGan] || '甲';
        const ganArray = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
        let startIndex = ganArray.indexOf(startGan);

        let html = '';
        for(let i=0; i < 12; i++) {
            let gan = ganArray[(startIndex + i) % 10];
            let zhi = shichenZhi[i];
            let timeStr = i === 0 ? "23-1点" : `${i*2-1}-${i*2+1}点`;
            
            html += `
                <div class="item-box" id="ls-box-${i}" onclick="selectLiuShi(${i})">
                    <div class="top-text">${timeStr}</div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, gan)}</span><span class="ganzhi-text" style="color:${getColor(gan)}">${gan}</span></div>
                    <div class="gz-row"><span class="ss-text">${getSS(globalDayGan, zhi, true)}</span><span class="ganzhi-text" style="color:${getColor(zhi)}">${zhi}</span></div>
                </div>`;
        }
        document.getElementById('liushiRow').innerHTML = html;
        selectLiuShi(0); 
    }

    function selectLiuShi(lsIndex) {
        if (isDragging) return;
        document.querySelectorAll('#liushiRow .item-box').forEach(el => el.classList.remove('active'));
        const box = document.getElementById(`ls-box-${lsIndex}`);
        if(box) box.classList.add('active');
    }

    // ==========================================
    // 算法修复：完全依赖真实的八字干支去寻路定位
    // ==========================================
    function snapToNow() {
        const now = new Date();
        const nowLunar = Lunar.fromDate(now);
        const nowBazi = nowLunar.getEightChar();
        const nowYear = now.getFullYear();
        
        // 提取此时此刻真正的八字年份和月份干支（无视立春边界问题）
        const targetNianGz = nowBazi.getYearGan() + nowBazi.getYearZhi();
        const targetYueGz = nowBazi.getMonthGan() + nowBazi.getMonthZhi();

        let dyIndex = 0;
        let lnIndex = 0;
        let found = false;
        
        // 1 & 2. 寻找大运和流年（解决跨年误差）
        for (let i = 0; i < 8; i++) {
            if (!globalDaYuns[i]) continue;
            let lnList = globalDaYuns[i].getLiuNian();
            for(let j=0; j < lnList.length; j++) {
                // 确保公历年份误差不超过1，且干支完全吻合，双重保障
                if (Math.abs(lnList[j].getYear() - nowYear) <= 1 && lnList[j].getGanZhi() === targetNianGz) {
                    dyIndex = i;
                    lnIndex = j;
                    found = true;
                    break;
                }
            }
            if(found) break;
        }
        selectDaYun(dyIndex);
        selectLiuNian(dyIndex, lnIndex);

        // 3. 寻找真实流月
        let lyIndex = 0;
        let lyList = globalDaYuns[dyIndex].getLiuNian()[lnIndex].getLiuYue();
        for(let i=0; i < lyList.length; i++) {
            if (lyList[i].getGanZhi() === targetYueGz) {
                lyIndex = i; 
                break;
            }
        }
        selectLiuYue(dyIndex, lnIndex, lyIndex);

        // 4. 寻找流日 DOM 元素
        let lrIndex = 0;
        let targetDateStr = `${now.getMonth() + 1}/${now.getDate()}`;
        let lrBoxes = document.querySelectorAll('#liuriRow .item-box');
        for(let i=0; i < lrBoxes.length; i++) {
            if(lrBoxes[i].querySelector('.top-text').innerText === targetDateStr) {
                lrIndex = i;
                break;
            }
        }
        selectLiuRi(nowBazi.getDayGan(), lrIndex);

        // 5. 换算此时的流时 (例如: 11点~13点为午时)
        let hourIndex = Math.floor((now.getHours() + 1) / 2) % 12;
        selectLiuShi(hourIndex);

        // 6. UI平滑滚动居中
        setTimeout(() => {
            document.getElementById(`dy-box-${dyIndex}`)?.scrollIntoView({inline: 'center', behavior: 'smooth'});
            document.getElementById(`ln-box-${lnIndex}`)?.scrollIntoView({inline: 'center', behavior: 'smooth'});
            document.getElementById(`ly-box-${lyIndex}`)?.scrollIntoView({inline: 'center', behavior: 'smooth'});
            document.getElementById(`lr-box-${lrIndex}`)?.scrollIntoView({inline: 'center', behavior: 'smooth'});
            document.getElementById(`ls-box-${hourIndex}`)?.scrollIntoView({inline: 'center', behavior: 'smooth'});
        }, 100); 
    }

    function initDragScroll() {
        const sliders = document.querySelectorAll('.scroll-row');
        sliders.forEach(slider => {
            let isDown = false, startX, scrollLeft;
            slider.addEventListener('mousedown', (e) => {
                isDown = true; isDragging = false; 
                slider.classList.add('active-drag');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active-drag'); });
            slider.addEventListener('mouseup', () => { 
                isDown = false; slider.classList.remove('active-drag');
                setTimeout(() => { isDragging = false; }, 50); 
            });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault(); 
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 1.5; 
                if (Math.abs(walk) > 5) isDragging = true;
                slider.scrollLeft = scrollLeft - walk;
            });
        });
    }

    window.onload = () => {
        document.getElementById('birthTime').value = "1995-02-06T02:00";
        initDragScroll(); 
        initPan();
    };
</script>
</body>
</html>